{% extends "base.html" %}

{% block title %}Goals{% endblock %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goals/Payments</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='goals.css') }}">
</head>
<body>
<div class="container goals-box">
    <h2>Goals</h2>
    <button id="openAddGoalModalButton" class="button-large"><i class="fa-solid fa-plus"></i> Goal</button>
    <div class="goals-list-box">
        <h3>Goals List</h3>
        <ul id="goalsList"></ul>
    </div>
</div>

<!-- The Modal for Adding a New Goal -->
<div id="addGoalModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeAddGoalModal">&times;</span>
        
        <h4>Add New Goal</h4>
        
        <div id="nameField">
            <label for="goalName">Name:</label>
            <input type="text" id="goalName" placeholder="Enter name">
        </div>
        
        <div id="amountField">
            <label for="goalAmountTotal">Total Amount ($):</label>
            <input type="number" id="goalAmountTotal" placeholder="Enter total amount">
        </div>

        <div id="currentAmountField">
            <label for="goalAmountCurrent">Current Amount ($):</label>
            <input type="number" id="goalAmountCurrent" placeholder="Enter current amount">
        </div>
        
        <button onclick="addGoal()" class="button-large">Save Goal</button>
    </div>
</div>

<script>
    // Get modal elements
    const addGoalModal = document.getElementById("addGoalModal");
    const openAddGoalModalButton = document.getElementById("openAddGoalModalButton");
    const closeAddGoalModal = document.getElementById("closeAddGoalModal");

    // Open modal for adding a new goal
    openAddGoalModalButton.onclick = function() {
        addGoalModal.style.display = "block";
    }

    // Close modal for adding a new goal
    closeAddGoalModal.onclick = function() {
        addGoalModal.style.display = "none";
    }

    // Close modals if user clicks outside of them
    window.addEventListener("click", function(event) {
        if (event.target === addGoalModal) {
            addGoalModal.style.display = "none";
        }
    });

    // Function to add a new goal to the list
    function addGoal() {
        // Get input values
        const goalName = document.getElementById('goalName').value;
        const goalAmountTotal = parseFloat(document.getElementById('goalAmountTotal').value);
        const goalAmountCurrent = parseFloat(document.getElementById('goalAmountCurrent').value);

        // Validate input
        if (goalName === '' || isNaN(goalAmountTotal) || isNaN(goalAmountCurrent)) {
            alert('Please fill in all fields with valid numbers.');
            return;
        }

        // Calculate progress percentage
        const progress = (goalAmountCurrent / goalAmountTotal) * 100;

        // Create a new list item
        const li = document.createElement('li');
        li.innerHTML = `
            <div class="goal-header">
                <strong>${goalName}</strong>
                <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${progress}%;"></div>
                </div>
                <i class="fas fa-chevron-down" onclick="toggleGoalDetails(this)"></i>
            </div>
            <div class="goal-details" style="display: none;">
                <div class="goal-info">
                    <div class="input-group">
                        <label>Total:</label>
                        <input type="number" class="edit-goal-amount-total" value="${goalAmountTotal}" disabled onchange="updateGoal(this)">
                    </div>
                    <div class="input-group">
                        <label>Current:</label>
                        <input type="number" class="edit-goal-amount-current" value="${goalAmountCurrent}" disabled onchange="updateGoal(this)">
                    </div>
                </div>
                <div class="goal-actions">
                    <button class="remove-button button-small" onclick="removeGoal(this)"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;

        // Append new item to goals list
        const goalsList = document.getElementById('goalsList');
        goalsList.appendChild(li);

        // Clear input fields
        document.getElementById('goalName').value = '';
        document.getElementById('goalAmountTotal').value = '';
        document.getElementById('goalAmountCurrent').value = '';

        // Close modal
        addGoalModal.style.display = "none";
    }

    // Function to toggle goal details (expand/collapse)
    function toggleGoalDetails(chevronIcon) {
        const goalDetails = chevronIcon.parentElement.nextElementSibling;
        const isExpanded = goalDetails.style.display === 'block';
        goalDetails.style.display = isExpanded ? 'none' : 'block';
        chevronIcon.classList.toggle('fa-chevron-down', isExpanded);
        chevronIcon.classList.toggle('fa-chevron-up', !isExpanded);

        if (!isExpanded) {
            // When expanded, make fields editable
            const editFields = goalDetails.querySelectorAll('.edit-goal-amount-total, .edit-goal-amount-current');
            editFields.forEach(field => field.removeAttribute('disabled'));
        } else {
            // When collapsed, disable fields
            const editFields = goalDetails.querySelectorAll('.edit-goal-amount-total, .edit-goal-amount-current');
            editFields.forEach(field => field.setAttribute('disabled', true));
        }
    }
    // Function to update the progress bar and other details when values are changed
    function updateGoal(input) {
        const goalDetails = input.closest('.goal-details');
        const goalHeader = goalDetails.previousElementSibling;
        
        // Get updated values
        const totalAmount = parseFloat(goalDetails.querySelector('.edit-goal-amount-total').value);
        const currentAmount = parseFloat(goalDetails.querySelector('.edit-goal-amount-current').value);

        if (isNaN(totalAmount) || isNaN(currentAmount)) {
            alert('Please enter valid numbers.');
            return;
        }

        // Update the progress bar
        const progress = (currentAmount / totalAmount) * 100;
        const progressBar = goalHeader.querySelector('.progress-bar');
        progressBar.style.width = `${progress}%`;
    }    

    // Function to remove a goal
    function removeGoal(button) {
        const goalToRemove = button.closest('li');
        goalToRemove.remove();
    }
</script>   

</body>
{% endblock %}
